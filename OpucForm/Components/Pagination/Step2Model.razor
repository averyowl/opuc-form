@inject IWebHostEnvironment Env
@using OpucForm.Shared

<h1>Service Account Information</h1>
<div class="step2 mt-4">
    <h3 class="step2__h">Selected Service Provider:</h3>
    <p class="step2__p application__text"><strong>@SelectedProvider</strong></p>
</div>

<div class="application__group--phoneinfo-i mt-5">
    <!-- Applicant's Phone or Broadband Account Number -->
    <label for="applicantPhone" class="application__form-label">
        A phone number or internet service account number is required to receive the Oregon Lifeline benefit.
        <span class="required">*</span>
    </label>

    <small class="text-muted d-block mb-2 application__form-small">
        Format: 123-123-1234
    </small>

    <input type="text" id="applicantPhone" class="form-control form-control-lg application__input" inputmode="numeric"
        placeholder="123-123-1234" maxlength="12" required />

    <small class="text-muted d-block mt-1 application__form-small">
        <strong>Note: </strong>If your account number has fewer than 10 digits, zeros will be added automatically after
        submission.
    </small>
</div>

<hr />

<div class="application__group--phoneinfo-i mt-5 mb-5">
    <h2><strong>Do you qualify for Lifeline through your child or a dependant?</strong></h2>
    <p class="application__text">If you are not eligible for Lifeline, you may apply through your child or dependent who
        participates in a qualifying program. <span class="required">*</span></p>

    <fieldset class="mt-3">
        <div class="application__radio-group">
            <label class="application__radio-option">
                <input type="radio" name="applicantType" id="childOrDependant" value="yes"
                    @onchange="() => OnChildDepChange(true)" required />
                Yes, through my child or dependant.
            </label>
            <label class="application__radio-option">
                <input type="radio" name="applicantType" id="myself" value="no"
                    @onchange="() => OnChildDepChange(false)" required />
                No, myself.
            </label>
        </div>
    </fieldset>

</div>

<hr />

@if (showChildDepSection)
{
    <!-- ONLY show if applicant selects "Yes, through my child or dependant." ABOVE. -->
    <div class="application__group--phoneinfo-i mt-5 mb-5">
        <h2><strong>Fill out your child or dependants information</strong></h2>
        <div class="application__group--name-div mb-3">
            <label class="application__form-label" for="firstName"><strong>First Name</strong> <span
                    class="required">*</span></label>
            <input type="text" class="form-control form-control-lg application__input" id="firstName"
                placeholder="First name" maxlength="30" required />
        </div>

        <div class="application__group--name-div mb-3">
            <label class="application__form-label" for="middleName"><strong>Middle Name</strong> (optional)</label>
            <input type="text" class="form-control form-control-lg application__input" id="middleName" maxlength="30"
                placeholder="Middle name" />
        </div>

        <div class="application__group--name-div">
            <label class="application__form-label" for="lastName"><strong>Last Name</strong> <span
                    class="required">*</span></label>
            <input type="text" class="form-control form-control-lg application__input" id="lastName" placeholder="Last name"
                maxlength="30" required />

        </div>
    </div>
    <hr />

    <div class="application__group--phoneinfo-i mt-5 mb-5">
        <h2><strong>Date of Birth</strong></h2>

        <label class="application__form-label" for="firstName">Format: 01/01/1975 <span class="required">*</span></label>
        <input type="date" class="form-control form-control-lg application__input" id="dob"
            min="@MinDob.ToString("yyyy-MM-dd")" max="@MaxDob.ToString("yyyy-MM-dd")" required />

    </div>


    <div class="application__group--phoneinfo-i mt-5 mb-5">
        <h2><strong>Social Security #</strong></h2>
        <p class="application__text">Enter the last 4 digits of their Social Security Number.</p>

        <label class="application__form-label" for="firstName">Last 4 digits of their SSN <span
                class="required">*</span></label>
        <input @bind="SSN" type="@InputType" class="form-control form-control-lg application__input" id="ssn"
            inputmode="numeric" placeholder="0000" maxlength="4" required />

        <div class="step2__check form-check mt-2">
            <input class="step2__check--input form-check-input" type="checkbox" id="showSSN" @bind="ShowSSN" />

            <label class="step2__check--label form-check-label" for="showSSN">
                Show SSN
            </label>
        </div>

    </div>
    <hr />
}


<!-- ALWAYS SHOW. -->

<div class="application__group--phoneinfo-i mt-5 mb-5">
    <h2><strong>Program Qualification</strong></h2>
    <p class="application__text">If you are applying for Oregon Lifeline on the basis of Federal Public Housing
        Assitance (Section 8), Veterans or Survivors Pension benefits, or any of the tribal benefits, you must submit
        valid documentation. <span class="required">*</span></p>
    <h2><strong>How Does the Applicant Quality for Oregon Lifeline?</strong></h2>

    <select id="qualificationProgram" name="qualificationProgram"
        class="form-control form-control-lg application__input application__input-select" value="@QualificationProgram"
        @onchange="OnQualificationChanged" required>
        <option value="">Select one</option>
        <option value="SNAP">
            Supplemental Nutrition Assistance Program (SNAP) — No
            Documentation Required
        </option>
        <option value="Medicaid">
            Medicaid — No Documentation Required
        </option>
        <option value="SSI">
            Supplemental Security Income (SSI) — Documentation Required
        </option>
        <option value="Housing">
            Federal Public Housing Assistance (Section 8) — Documentation
            Required
        </option>
        <option value="Veterans">
            Veterans or Survivors Pension — Documentation Required
        </option>
        <option value="Income">
            Total Household Income ≤ 135% of Federal Poverty Guidelines —
            Documentation Required
        </option>
        <option value="TribalGeneral">
            Tribal General Assistance — Documentation Required
        </option>
        <option value="TribalHeadStart">
            Tribal Head Start — Documentation Required
        </option>
        <option value="TribalTANF">
            Tribal TANF — Documentation Required
        </option>
        <option value="TribalFood">
            Tribal Food Distribution Program — Documentation Required
        </option>
    </select>

    @if (QualificationProgram == "Income")
    {

        <div id="incomeSection" class="form-section">
            <p class="form-note application__text">
                Since you qualify by income, please indicate the total number of
                household members (including applicant) with whom the applicant shares income
                and expenses. If the applicant is the only member of the household, please
                enter <strong>1</strong>.
            </p>
            <label for="txtNumberOfPeople" class="form-label application__form-label">
                Number of household members: <span class="required">*</span>
            </label>
            <input type="number" id="txtNumberOfPeople" name="txtNumberOfPeople" min="1" max="9"
                class="form-input application__input" placeholder="1" value="@NumberOfHouseholdMembers"
                @onchange="OnHouseholdMembersChanged" required />
        </div>

    }

    @if (!string.IsNullOrEmpty(QualificationProgram) &&
        ProgramDescriptions.TryGetValue(QualificationProgram, out var desc))
    {
        <div class="fade-down mt-3">
            <p class="application__text">@desc</p>
        </div>
    }

    @if (QualificationProgram == "SSI" ||
        QualificationProgram == "Housing" ||
        QualificationProgram == "Veterans" ||
        QualificationProgram == "TribalGeneral" ||
        QualificationProgram == "TribalHeadStart" ||
        QualificationProgram == "TribalTANF" ||
        QualificationProgram == "TribalFood" ||
        QualificationProgram == "Income")
    {

        <figure class="upload mt-5">
            <h5>Please upload documentation <span class="required">*</span></h5>
            <div class="mt-5 upload__wrapper @(isDragOver ? "upload__wrapper-drag" : "")" @ondragover:preventDefault="true"
                @ondragover="OnDragOver" @ondragleave="OnDragLeave">

                <label class="upload__label">
                    <div class="upload__top">
                        <div class="upload__top-icon">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <div class="upload__top-text">
                            <p class="application__text">Select a file or drag and drop here.</p>
                            <p class="application__text">.PDF, .DOC, or .DOCX file types. File size no more than 10MB.</p>
                        </div>
                    </div>
                    <button class="btn btn-primary upload__btn"><span>Select File</span></button>
                    <span
                        style="text-align: center;"">@(SelectedFileName ?? "")</span>
                                                                                                                                        <InputFile @key="
                                                                                                                                                   FileInputKey" name="uploadFile" id="fileInput" OnChange="OnFileSelected" accept=".pdf,.doc,.docx"
                    required />
            </label>
        </div>

        </figure>

    @if (!string.IsNullOrEmpty(SelectedFileName))
        {
            <button type="button" class="btn btn-link text-danger mt-2 application__text" @onclick="ClearFile">
                Remove file
            </button>
        }

        @if (!string.IsNullOrEmpty(UploadError))
        {
            <p class="text-danger mt-2 application__text">@UploadError</p>
        }


    }

</div>



@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Parameter] public string SelectedProvider { get; set; } = "";

    /* ================= FILE UPLOAD & QUALIFICATION TYPE ================= */
    [Parameter] public string QualificationProgram { get; set; } = "";
    [Parameter] public EventCallback<string> QualificationProgramChanged { get; set; }
    [Parameter] public UploadedDocumentDto? UploadedDocument { get; set; }
    [Parameter] public EventCallback<UploadedDocumentDto> UploadedDocumentChanged { get; set; }

    /* ================= FILE UPLOAD & QUALIFICATION TYPE ================= */

    /* ================= QUALIFICATION TYPE: Income ================= */
    [Parameter] public int? NumberOfHouseholdMembers { get; set; }
    [Parameter] public EventCallback<int?> NumberOfHouseholdMembersChanged { get; set; }
    /* ================= QUALIFICATION TYPE: Income ================= */

    // Explain what each of the qualification programs are
    private readonly Dictionary<string, string> ProgramDescriptions = new()
    {
        ["SNAP"] = "SNAP provides monthly food benefits to eligible low-income individuals and families. SNAP participation automatically qualifies you with no documentation required.",
        ["Medicaid"] = "Medicaid is a state and federal program that provides health coverage for eligible low-income adults, children, pregnant women, seniors, and people with disabilities. No documentation required",
        ["SSI"] = "SSI provides monthly payments to adults and children with disabilities or blindness who have limited income and resources. Documentation is required to verify eligibility.",
        ["Housing"] = "Federal Public Housing Assistance (Section 8) helps eligible low-income families with housing costs. Proof of participation is required.",
        ["Veterans"] = "Veterans or Survivors Pension benefits provide financial support to wartime veterans or their survivors. Documentation is required.",
        ["Income"] = "You may qualify if your household income is at or below 135% of the Federal Poverty Guidelines. Income documentation is required.",
        ["TribalGeneral"] = "Tribal General Assistance provides monthly cash assistance to eligible American Indian and Alaska Native individuals.",
        ["TribalHeadStart"] = "Tribal Head Start is a program promoting school readiness for young tribal children from low-income families. Documentation is required.",
        ["TribalTANF"] = "Tribal TANF provides financial assistance and support services to tribal families with children. Documentation required.",
        ["TribalFood"] = "The Tribal Food Distribution Program provides USDA foods to income-eligible tribal households. Documentation required."
    };

    /* ==================== Code for documentation upload & client-side validation ==================== */
    private IBrowserFile? SelectedFile;
    private string? SelectedFileName;
    private string? UploadError;
    private Guid FileInputKey = Guid.NewGuid();


    // Whenever the user updates the input, notify the parent:
    private async Task OnHouseholdMembersChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            NumberOfHouseholdMembers = value;
            await NumberOfHouseholdMembersChanged.InvokeAsync(value);
        }
        else
        {
            NumberOfHouseholdMembers = null;
            await NumberOfHouseholdMembersChanged.InvokeAsync(null);
        }
    }

    // Clear file helper method
    private async void ClearFile()
    {
        SelectedFile = null;
        SelectedFileName = null;
        UploadedDocument = null;
        await UploadedDocumentChanged.InvokeAsync(null);
        FileInputKey = Guid.NewGuid(); // reset InputFile
    }
    // Clear file error helper method
    private void ClearError()
    {
        UploadError = null;
    }

    [Parameter] public EventCallback<UploadedDocumentDto> OnDocumentSelected { get; set; }


    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        ClearError();

        if (e.FileCount == 0)
            return;

        SelectedFile = e.File;
        SelectedFileName = SelectedFile.Name;


        if (!ValidateFile())
        {
            // Clear only AFTER validation fails
            ClearFile();
            FileInputKey = Guid.NewGuid(); // resets <InputFile>
            return;
        }

        // Valid file -> read it.
        using var stream = SelectedFile.OpenReadStream(maxAllowedSize: 10_000_000);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var uploaded = new UploadedDocumentDto
        {
            FileName = SelectedFile.Name,
            ContentType = SelectedFile.ContentType,
            Data = ms.ToArray()
        };

        // Send back to parent
        UploadedDocument = uploaded;
        await UploadedDocumentChanged.InvokeAsync(uploaded);

    }

    private async Task OnQualificationChanged(ChangeEventArgs e)
    {
        QualificationProgram = e.Value?.ToString() ?? "";

        // CLEAR household count if not Income
        if (QualificationProgram != "Income")
        {
            NumberOfHouseholdMembers = null;
            await NumberOfHouseholdMembersChanged.InvokeAsync(null);
        }

        await QualificationProgramChanged.InvokeAsync(QualificationProgram);
    }


    // Validate that the file is under 10MB, and either PDF, Doc, or Docx file.
    private bool ValidateFile()
    {
        if (SelectedFile == null)
        {
            UploadError = "Please select a file.";
            return false;
        }

        if (SelectedFile.Size > 10_000_000) // 10 MB
        {
            UploadError = "File size must be under 10 MB.";
            return false;
        }

        // Allowed file types: PDF, DOC, DOCX
        var allowedTypes = new[]
        {
"application/pdf", // .pdf
"application/msword", // .doc
"application/vnd.openxmlformats-officedocument.wordprocessingml.document" // .docx
};

        if (!allowedTypes.Contains(SelectedFile.ContentType))
        {
            UploadError = "Invalid file type. Please upload a .PDF, .DOC, or .DOCX file.";
            return false;
        }

        UploadError = null;
        return true;
    }

    // Drag & Drop functionality
    private bool isDragOver;
    private void OnDragOver(DragEventArgs e)
    {
        isDragOver = true;
    }

    private void OnDragLeave(DragEventArgs e)
    {
        isDragOver = false;
    }

    // Upload file to server


    /* ==================== Code for documentation upload & client-side validation ==================== */

    /* ==================== Make qualification type persistent ==================== */

    private string SSN { get; set; }
    private bool ShowSSN { get; set; } = false;
    private bool showChildDepSection = false;
    private string InputType => ShowSSN ? "text" : "password";

    private void OnChildDepChange(bool isChildOrDep)
    {
        showChildDepSection = isChildOrDep;
    }

    /* Code to ensure the applicant can only enter dates up to 115 years old. */
    public DateTime MaxDob => DateTime.Today.AddYears(-115);
    public DateTime MinDob => DateTime.Today;


}